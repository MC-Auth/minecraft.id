<!DOCTYPE html>
<html ng-app="mcauthApp" ng-controller="mcauthController">
<head>
    <title ng-bind="head.pageTitle">MinecraftID - Authenticate & Link Users to their Minecraft account</title>
    <update-title content="{{head.pageTitle}}"></update-title>
    <link id="favicon" rel="shortcut icon" type="image/png" href="/favicon.png"/>

    <meta name="description" content="MinecraftID allows players to link their Minecraft account to websites, apps, etc.">
    <meta name="keywords" content="minecraft,authentication,link,login,register">
    <meta name="author" content="inventivetalent">

    <meta property="og:type" content="website">
    <meta property="og:title" content="Minecraft Authentication">
    <update-meta property="og:title" content="{{head.seoTitle}}"></update-meta>
    <meta property="og:image" content="https://minecraft.id/img/mcauth-256.png">
    <meta property="og:description" content="MinecraftID allows players to link their Minecraft account to websites, apps, etc.">

    <meta property="twitter:title" content="Minecraft Authentication">
    <update-meta property="twitter:title" content="{{head.seoTitle}}"></update-meta>
    <meta property="twitter:image" content="https://minecraft.id/img/mcauth-256.png">
    <meta property="twitter:description" content="MinecraftID allows players to link their Minecraft account to websites, apps, etc.">
    <meta property="twitter:creator" content="@Inventivtalent">
    <meta property="twitter:card" content="summary">

    <meta name="flattr:id" content="okelw0">

    <meta name="robots" content="index, follow">

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

    <meta name=viewport content="width=device-width, initial-scale=1">

    <base href="/">

    <!-- Cookie Consent by TermsFeed https://www.TermsFeed.com -->
    <script charset="UTF-8" src="https://www.termsfeed.com/public/cookie-consent/4.1.0/cookie-consent.js" type="text/javascript"></script>
    <script charset="UTF-8" type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            cookieconsent.run({"notice_banner_type":"simple","consent_type":"express","palette":"dark","language":"en","page_load_consent_levels":["strictly-necessary"],"notice_banner_reject_button_hide":false,"preferences_center_close_button_hide":false,"page_refresh_confirmation_buttons":false,"website_name":"inventivetalent","website_privacy_policy_url":"https://legal.inventivetalent.org/privacy"});
        });
    </script>

    <!-- google adsense -->
    <script async data-cookie-consent="targeting" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2604356629473365" type="text/plain"></script>
    <!-- end of google adsense-->

    <!-- google analytics -->
    <!-- Google tag (gtag.js) -->
    <script async data-cookie-consent="tracking" src="https://www.googletagmanager.com/gtag/js?id=G-8V12DT2T4V"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-8V12DT2T4V');
    </script>
    <!-- end of google analytics-->

    <noscript>Free cookie consent management tool by <a href="https://www.termsfeed.com/privacy-policy-generator/">TermsFeed Free Privacy Policy Generator</a></noscript>
    <!-- End Cookie Consent by TermsFeed https://www.TermsFeed.com -->
</head>
<body ng-cloak>

<a href="https://github.com/MC-Auth" ng-hide="auth.isUserOnAuthPage() && auth.style === 'simple'">
    <img style="position: absolute; top: 0; right: 0; border: 0;"
         src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67"
         alt="Fork me on GitHub"
         data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png">
</a>

<div class="container-fluid">
    <div class="jumbotron" ng-hide="auth.isUserOnAuthPage() && auth.style === 'simple'">
        <div class="container">
            <div class="row">
                <div class="col-md-2">
                    <a href="https://minecraft.id"><img src="/img/mcauth-256.png" class="img-responsive" onclick="window.location='/'"></a>
                </div>
                <div class="col-md-10">
                    <h1 onclick="window.location='/'">Minecraft Authentication</h1>
                </div>
            </div>
            <br/>
            <div class="row">
                <div class="col-md-12">
                    <p>
                        Authenticate Users with their Minecraft Account<br/>
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="container" style="padding-bottom: 100px;">
        <div ng-view></div>
        <div ng-show="auth.isUserOnAuthPage() && auth.style === 'simple'">
            <span class="text-muted">Powered by <a href="https://minecraft.id" target="_blank">MinecraftID</a></span>
        </div>
    </div>
</div>

<footer class="footer navbar-fixed-bottom" style="background-color: #f5f5f5; padding-top: 16px; padding-bottom: 16px;" ng-hide="auth.isUserOnAuthPage() && auth.style === 'simple'">
    <div class="container">
        <div class="row">
            <div class="col-sm-6">
                <span>Maintained by <a href="https://inventivetalent.org/?utm_source=mcauth&utm_medium=author_link" target="_blank">inventivetalent</a></span>
                &nbsp;
                &nbsp;
                Not affiliated with Minecraft / Mojang AB.
            </div>
            <div class="col-sm-6">
                <span class="pull-right">
                </span>
            </div>
        </div>
    </div>
</footer>


<div id="authModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>

            <div class="modal-body">
                <iframe id="authModalIframe" src="" style="width: 100%; min-height: 200px; border-style: none; padding: 10px;">
                </iframe>
            </div>

            <div class="modal-footer">
                <button class="btn btn-success" onclick="window.open('/howto','_blank')" title="Need help?"><i class="fa fa-question" aria-hidden="true"></i></button>
                <button class="btn btn-primary" ng-click="auth.goToAuthPage()" title="Back to the authentication page"><i class="fa fa-arrow-right" aria-hidden="true"></i></button>
            </div>
        </div>
    </div>
</div>

    <script>
        if (location.host !== "minecraft.id") {
            window.location = "https://minecraft.id"+location.pathname;
        }
    </script>

<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js" integrity="sha384-V6/dyDFv85/V/Ktq3ez5B80/c9ZY7jV9c/319rqwNOz3h9CIPdd2Eve0UQBYMMr/" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-route.js" integrity="sha384-k+Qp/8rZxoiiYGVjOBiZwkEp5yv6clgl2EmwNaE1oUMlfmEYgCWazxf4CyxfZiWG" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.0/angular-cookies.min.js" integrity="sha384-4Rqc4WCYcTgQGo7N/eJANj8VFLYiS0J/XRW6ThAPed/9YJmlNO7iD+ZdbeKi1Eqx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>

<script src="/js/update-meta.min.js"></script>

<script>
    var authApp = angular.module("mcauthApp", ["ngRoute", "ngCookies"]);

    authApp.config(function ($routeProvider, $locationProvider, $httpProvider) {

        $routeProvider
                .when("/", {
                    templateUrl: "/pages/index.html"
                })
                .when("/auth", {
                    templateUrl: "/pages/auth.html",
                    controller: "authController"
                })
                .when("/documentation", {
                    templateUrl: "/pages/documentation.html",
                    controller: "documentationController"
                })
                .when("/howto", {
                    templateUrl: "/pages/howto.html",
                    controller: "howtoController"
                })
                .when("/demo/:returnValues?", {
                    templateUrl: "/pages/demo.html",
                    controller: "demoController"
                })


        $locationProvider.html5Mode(true);

        // Required for session cookies to be sent in $http
        $httpProvider.defaults.withCredentials = true;
    });

    authApp.controller("mcauthController", ["$scope", "$route", "$cookies", "$location", "$http", "$interval", function ($scope, $route, $cookies, $location, $http, $interval) {
        console.info("mcauthController");
        console.log($location.path())

        $scope.head = {
            pageTitle: "MinecraftID - Authenticate & Link Users to their Minecraft account",
            seoTitle: "Minecraft Authentication"
        };

        $scope.auth = {
            id: $cookies.get("mcauth_id"),
            requestId: $cookies.get("mcauth_request_id"),
            username: $cookies.get("mcauth_username"),
            style: $cookies.get("mcauth_style"),
            getId: function () {
                return $scope.auth.id ? atob($scope.auth.id) : undefined
            },
            getRequestId: function () {
                return $scope.auth.requestId ? atob($scope.auth.requestId) : undefined;
            },
            getUsername: function () {
                return $scope.auth.username ? atob($scope.auth.username) : undefined;
            },
            isUserOnAuthPage: function () {
                return $location.path() === "/auth";
            },
            goToAuthPage: function () {
                window.location = 'https://api.minecraft.id/auth/authorize/' + $scope.auth.getId() + '?request_id=' + $scope.auth.getRequestId() + '&username=' + $scope.auth.getUsername() + '&style=default';
            },
            request: {
                status: "STARTED",
                created: 0
            },
            expiration: {
                duration: 0,
                durationText: ""
            },
            checkInterval: undefined,
            timerInterval: undefined,
            enteredToken: ""
        };

        if (!$scope.auth.isUserOnAuthPage() && $scope.auth.id) {
            $http({
                url: "https://api.minecraft.id/auth/api/check/" + $scope.auth.getId()
            }).then(function (response) {
                console.log(response);
                $scope.auth.request.status = response.data.status;
                $scope.auth.request.created = response.data.created;
                console.log("Status: " + $scope.auth.request.status)

                if ($scope.auth.request.status === "REQUESTED") {
                    var iframe = $("#authModalIframe");
                    var modal = $("#authModal");
                    iframe.attr("src", "https://api.minecraft.id/auth/authorize/" + $scope.auth.getId() + "?request_id=" + $scope.auth.getRequestId() + "&username=" + $scope.auth.getUsername() + "&style=simple");
                    iframe.on("load", function () {
                        var iframeResizeInterval = $interval(function () {
                            if (iframe.attr("src").length == 0) {
                                $interval.cancel(iframeResizeInterval);
                            } else {
                                iframe.css("height", document.getElementById("authModalIframe").contentWindow.document.body.scrollHeight + 20);
                            }
                        }, 500);
                    });
                    modal.modal("show");
                    modal.on('hidden.bs.modal', function () {
                        console.log("modal closed")
                        iframe.attr("src", "");
                    })
                }
            }, function (error) {
                console.warn(error);
                if (error.status == 404) {
                    $scope.auth.request.status = "NOT_FOUND";
                }
            });
        }
    }]);

    authApp.controller("authController", ["$scope", "$http", "$cookies", "$timeout", "$interval", "$location", function ($scope, $http, $cookies, $timeout, $interval, $location) {
        $scope.head.pageTitle = "Authentication - MinecraftID";
        $scope.head.seoTitle = "Authentication - MinecraftID";


        console.info("authController");
//        console.log($location.path())

        $scope.refreshStatus = function () {
            $http({
                url: "https://api.minecraft.id/auth/api/check/" + $scope.auth.getId()
            }).then(function (response) {
                console.log(response);
                $scope.auth.request.status = response.data.status;
                console.log("Status: " + $scope.auth.request.status)

                if ($scope.auth.request.status === 'TIMEOUT_LOGIN' || $scope.auth.request.status === 'TIMEOUT_TOKEN' || $scope.auth.request.status === 'VERIFIED' || $scope.auth.request.status === 'INVALID_TOKEN' || $scope.auth.request.status === 'FAILED') {
                    $timeout(function () {
                        window.location = "https://api.minecraft.id/auth/finish/" + $scope.auth.getId()
                    }, 2000);
                    $interval.cancel($scope.auth.checkInterval);
                    $interval.cancel($scope.auth.timerInterval);
                }
            }, function (error) {
                console.warn(error)
                //TODO
            });
        };

        $(window).on("focus", $scope.refreshStatus);

        $timeout(function () {
            if ($scope.auth.id && $scope.auth.requestId && $scope.auth.username) {
                $http({
                    url: "https://api.minecraft.id/auth/api/check/" + $scope.auth.getId()
                }).then(function (response) {
                    console.log(response);
                    $scope.auth.request.status = response.data.status;
                    $scope.auth.request.created = response.data.created;
                    console.log("Status: " + $scope.auth.request.status)

                    if ($scope.auth.checkInterval) {
                        $interval.cancel($scope.auth.checkInterval);
                    }
                    $scope.auth.checkInterval = $interval($scope.refreshStatus, 4000);

                    if ($scope.auth.timerInterval) {
                        $interval.cancel($scope.auth.timerInterval);
                    }
                    $scope.auth.timerInterval = $interval(function () {
                        $scope.auth.expiration.duration = moment.duration(moment($scope.auth.request.created).add(5, "minutes") - moment());
                        $scope.auth.expiration.durationText = moment($scope.auth.expiration.duration.asMilliseconds()).format("mm:ss");

                        if ($scope.auth.request.status === "STARTED" || $scope.auth.request.status === "REQUESTED") {
                            $scope.head.pageTitle = "Join Minecraft | " + $scope.auth.expiration.durationText + " | Authentication - MinecraftID";
                        } else if ($scope.auth.request.status === "TOKEN_GENERATED") {
                            $scope.head.pageTitle = "Enter Token | " + $scope.auth.expiration.durationText + " | Authentication - MinecraftID";
                        } else if ($scope.auth.request.status === "VERIFIED" || $scope.auth.request.status === "INVALID_TOKEN") {
                            $scope.head.pageTitle = "Redirecting... | Authentication - MinecraftID";
                        } else {
                            $scope.head.pageTitle = "Authentication - MinecraftID";
                        }
                    }, 1000);
                }, function (error) {
                    console.warn(error);
                    if (error.status == 404) {
                        $scope.auth.request.status = "NOT_FOUND";
                    }
                });
            } else {
                $scope.auth.request.status = "NOT_FOUND";
            }
        }, 500);

        $scope.submitToken = function () {
            if ($scope.auth.enteredToken.length !== 6) {
                return;
            }

            $http({
                url: "https://api.minecraft.id/auth/api/verify/" + $scope.auth.getId() + "?token=" + $scope.auth.enteredToken,
            }).then(function (response) {
                console.log(response);
                $timeout(function () {
                    $scope.auth.request.status = response.data.status;
                }, 500);
            });

        };
    }]);

    authApp.controller("demoController", ["$scope", "$routeParams", "$location", function ($scope, $routeParams, $location) {
        $scope.head.pageTitle = "Demo - MinecraftID";
        $scope.head.seoTitle = "Demo - MinecraftID";

        console.info("demoController");
//        console.log($location.path())
//        console.log($routeParams);
//        console.log($routeParams.returnValues)
        $scope.iframeSrc = "https://minecraft.id/_demo/index.php";
        if ($routeParams.returnValues) {
            var split = $routeParams.returnValues.split(",");
            var id = split[0];
            var requestId = split[1];
            var code = split[2];

            $scope.iframeSrc = "https://minecraft.id/_demo/index.php?id=" + id + "&request_id=" + requestId + "&code=" + code;
        }
    }]);

    authApp.controller("howtoController", ["$scope", function ($scope) {
        $scope.head.pageTitle = "How To - MinecraftID";
        $scope.head.seoTitle = "How To - MinecraftID";
    }]);

    authApp.controller("documentationController", ["$scope", function ($scope) {
        $scope.head.pageTitle = "Documentation - MinecraftID";
        $scope.head.seoTitle = "Documentation - MinecraftID";
    }]);
</script>
</body>
</html>
